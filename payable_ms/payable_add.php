<?php

session_start();

$memberID = $_SESSION['memberID'];
$powerkey = $_SESSION['powerkey'];


require_once '/website/os/Mobile-Detect-2.8.34/Mobile_Detect.php';
$detect = new Mobile_Detect;


@include_once("/website/class/".$site_db."_info_class.php");

/* 使用xajax */
@include_once '/website/xajax/xajax_core/xajax.inc.php';
$xajax = new xajax();

$xajax->registerFunction("processform");

function processform($aFormValues){

	$objResponse = new xajaxResponse();

	if (trim($aFormValues['payable_type']) == "") {
		$objResponse->script("jAlert('警示', '請選擇應付性質', 'red', '', 2000);");
		return $objResponse;

	}


	if (trim($aFormValues['contract_type']) == "") {
		$objResponse->script("jAlert('警示', '請選擇應付合約種類', 'red', '', 2000);");
		return $objResponse;

	}

	if (trim($aFormValues['payment']) == "") {
		$objResponse->script("jAlert('警示', '請選擇付款方式', 'red', '', 2000);");
		return $objResponse;

	}

	if (trim($aFormValues['makeby']) == "") {
		$objResponse->script("jAlert('警示', '請輸入經辦人', 'red', '', 2000);");
		return $objResponse;

	}
	
	if (trim($aFormValues['requirement_description']) == "") {
		$objResponse->script("jAlert('警示', '請輸入應付項目需求說明', 'red', '', 2000);");
		return $objResponse;

	}

	if (trim($aFormValues['invoice_order_date']) == "") {
		$objResponse->script("jAlert('警示', '請輸入項目日期', 'red', '', 2000);");
		return $objResponse;

	}

	if (trim($aFormValues['supplier_id']) == "") {
		$objResponse->script("jAlert('警示', '請選擇廠商', 'red', '', 2000);");
		return $objResponse;

	}

	
	
	$fm							= trim($aFormValues['fm']);
	$site_db					= trim($aFormValues['site_db']);
	$templates					= trim($aFormValues['templates']);
	$handler_id					= trim($aFormValues['handler_id']);
	$big_fixed 					= (trim($aFormValues['big_fixed']) === "Y") ? "Y" : "N";
	$payable_type				= trim($aFormValues['payable_type']);
	$contract_id 				= trim($aFormValues['contract_id']);
	$contract_type 				= trim($aFormValues['contract_type']);
	$payment 					= trim($aFormValues['payment']);
	$invoice_no				    = trim($aFormValues['invoice_no']);
	$invoice_amt				    = trim($aFormValues['invoice_amt']);
	$makeby 					= trim($aFormValues['makeby']);
	$requirement_description 	= trim($aFormValues['requirement_description']);
	$invoice_order_date 		= trim($aFormValues['invoice_order_date']);
	$supplier_id 				= trim($aFormValues['supplier_id']);
	$location 					= trim($aFormValues['location']);
	$payable_order_id 			= "";

	// 應付編號生成
	$mDB = "";
	$mDB = new MywebDB();
	$Qry="select * from contract where contract_id='$contract_id' ";
	$mDB->query($Qry);
	if ($mDB->rowCount() > 0) {
		$row=$mDB->fetchRow(2);
		$contract_code = $row['contract_code'];
		$roc_year = date("Y") - 1911;
		$step_payable_order_id = $contract_code . "_" . sprintf("%03d", $roc_year) . date("md") . "_";
	}
		
	$mDB2 = "";
	$mDB2 = new MywebDB();
	$Qry2 = "SELECT payable_order_id 
         FROM payable 
         WHERE LEFT(payable_order_id, LENGTH(payable_order_id) - 2) = '$step_payable_order_id'
         ORDER BY payable_order_id DESC 
         LIMIT 1";
	$mDB2->query($Qry2);
	if ($mDB2->rowCount() > 0) {
        $row3 = $mDB2->fetchRow(2);
        $last_id = $row3['payable_order_id'];
        $last_sn = substr($last_id, -2); // 取最後兩碼流水號
        $new_sn = sprintf("%02d", intval($last_sn) + 1); // 加1並補零
    } else {
        $new_sn = "01"; // 第一筆從 01 開始
    }

	// 組成新的應付單號
    $payable_order_id = $step_payable_order_id . $new_sn;


	//存入實體資料庫中
	$mDB = "";
	$mDB = new MywebDB();
	
	$now = date("Y-m-d H:i:s");
	$Qry = " INSERT INTO `payable` (
    `payable_order_id`,
    `handler_id`,
    `payable_type`,
    `contract_id`,
    `contract_type`,
	`payment`,
    `makeby`,
	`invoice_no`,
	`invoice_amt`,
    `requirement_description`,
    `invoice_order_date`,
    `supplier_id`,
    `location`,
    `created_at`,
    `last_modify`
) VALUES (
    '$payable_order_id',
    '$handler_id',
    '$payable_type',
    '$contract_id',
    '$contract_type',
	'$payment',
    '$makeby',
	'$invoice_no',
	'$invoice_amt',
    '$requirement_description',
    '$invoice_order_date',
    '$supplier_id',
    '$location',
    '$now',
    '$now'
)";
	$mDB->query($Qry);

	$mDB->remove();
	if (!empty($payable_order_id)) {
		$objResponse->script("myDraw();");
		$objResponse->script("art.dialog.tips('已新增，請繼續輸入其他資料...',2);");
		$objResponse->script("parent.$.fancybox.close();");
	} else {
		$objResponse->script("jAlert('警示', '發生不明原因的錯誤，資料未新增，請再試一次!', 'red', '', 2000);");
		$objResponse->script("parent.$.fancybox.close();");
	}
	
	return $objResponse;	
}



$xajax->processRequest();

$fm = $_GET['fm'];
$t = $_GET['t'];

$mess_title = $title;

//從會員帳號取得員工代號
$employee_row = getkeyvalue2($site_db.'_info','employee',"member_no = '$memberID'",'employee_id');
$employee_id = $employee_row['employee_id'];

$mDB = "";
$mDB = new MywebDB();

$Qry="SELECT employee_id,employee_name from employee where employee_id = '$employee_id'";
$mDB->query($Qry);
if ($mDB->rowCount() > 0) {
	$row=$mDB->fetchRow(2);
	$makeby = $row['employee_name'];
	$employee_id = $row['employee_id'];
}

$default_day = date("Y-m-d");

$mDB = "";
$mDB = new MywebDB();


//載入合約

$Qry="SELECT auto_seq,contract_id,contract_caption FROM contract ORDER BY auto_seq";
$mDB->query($Qry);
$select_contract = "";
$select_contract .= "<option></option>";

if ($mDB->rowCount() > 0) {
	while ($row=$mDB->fetchRow(2)) {
		$contract_id = $row['contract_id'];
		$contract_name = $row['contract_caption'];
		$select_contract .= "<option value=\"$contract_id\" ".mySelect($contract_id,"").">$contract_name</option>";
	}
}

//載入廠商

$Qry="SELECT supplier_id,supplier_name,short_name FROM supplier ORDER BY supplier_id";
$mDB->query($Qry);
$select_supplier = "";
$select_supplier .= "<option></option>";

if ($mDB->rowCount() > 0) {
	while ($row=$mDB->fetchRow(2)) {
		$supplier_id = $row['supplier_id'];
		$supplier_name = $row['supplier_name'];
		$select_supplier .= "<option value=\"$supplier_id\" ".mySelect($supplier_id,"").">$supplier_id $supplier_name</option>";
	}
}

// 載入付款方式
$Qry="SELECT caption FROM items where pro_id ='payment' ORDER BY pro_id,orderby";
$mDB->query($Qry);
$select_payment = "";
$select_payment .= "<option></option>";

if ($mDB->rowCount() > 0) {
	while ($row=$mDB->fetchRow(2)) {
		$ch_payment = $row['caption'];
		$select_payment .= "<option value=\"$ch_payment\" ".mySelect($ch_payment,$payment).">$ch_payment</option>";
	}
}
  
$mDB->remove();



if (!($detect->isMobile() && !$detect->isTablet())) {
	$isMobile = 0;

$style_css=<<<EOT
<style>

.card_full {
    width: 100vw;
	height: 100vh;
}

#full {
    width: 100vw;
	height: 100vh;
}

#info_container {
	width: 100% !Important;
	max-width: 1400px; !Important;
	margin: 0 auto !Important;
}

.field_div1 {width:100%;max-width:150px;display: none;font-size:18px;color:#000;text-align:right;font-weight:700;padding:15px 10px 0 0;vertical-align: top;display:inline-block;zoom: 1;*display: inline;}
.field_div2 {width:100%;max-width:400px;display: none;font-size:18px;color:#000;text-align:left;font-weight:700;padding:8px 0 0 0;vertical-align: top;display:inline-block;zoom: 1;*display: inline;}
.field_div3 {width:100%;max-width:400px;display: none;font-size:18px;color:#000;text-align:left;font-weight:700;padding:8px 0 0 0;vertical-align: top;display:inline-block;zoom: 1;*display: inline;}

</style>
EOT;

} else {
	$isMobile = 1;
$style_css=<<<EOT
<style>

.card_full {
    width: 100vw;
	height: 100vh;
}

#full {
    width: 100vw;
	height: 100vh;
}

#info_container {
	width: 100% !Important;
	margin: 0 auto !Important;
}

.field_div1 {width:100%;display: block;font-size:18px;color:#000;text-align:left;font-weight:700;padding:15px 10px 0 0;vertical-align: top;}
.field_div2 {width:100%;display: block;font-size:18px;color:#000;text-align:left;font-weight:700;padding:8px 10px 0 0;vertical-align: top;}

</style>
EOT;

}
	


$show_center=<<<EOT
$style_css
<div class="card card_full">
	<div class="card-header text-bg-info">
		<div class="size14 weight float-start">
			$mess_title
		</div>
	</div>
	<div id="full" class="card-body data-overlayscrollbars-initialize">
		<div id="info_container">
			<form method="post" id="addForm" name="addForm" enctype="multipart/form-data" action="javascript:void(null);">
				<div class="field_container3">
					<div class="container-fluid">
						<div class="row">
							<div class="col-lg-12 col-sm-12 col-md-12">
								<div class="field_div1">合約案別:</div> 
								<div class="field_div2">
									<select id="contract_id" name="contract_id" placeholder="請選擇合約" style="width:100%;max-width:250px;">
										$select_contract
									</select>
								</div> 
							</div> 
						</div>
						<div class="row">
							<div class="col-lg-6 col-sm-12 col-md-12">
								<div class="field_div1">合約類別:</div> 
								<div class="field_div2">
									<select id="contract_type" name="contract_type" placeholder="請選擇合約類別" style="width:100%;max-width:250px;">
										<option></option>
										<option value="合約內">合約內</option>
										<option value="合約外">合約外</option>
										<option value="其他">其他</option>
									</select>
								</div> 
							</div> 
						</div>
						<div class="row">
							<div class="col-lg-6 col-sm-6 col-md-6">
								<div class="field_div1">發票號碼:</div> 
								<div class="field_div2">
									<input type="text" class="inputtext" name="invoice_no" id="invoice_no" size="50" placeholder="請輸入發票號碼" maxlength="50" style="width:100%;max-width:250px;"/>
								</div> 
							</div> 
							<div class="col-lg-6 col-sm-6 col-md-6">
								<div class="field_div1">付款方式:</div> 
								<div class="field_div2">
									<select id="payment" name="payment" placeholder="請選擇付款方式" style="width:100%;max-width:250px;">
										$select_payment
									</select>
								</div> 
							</div> 
						</div>
						<div class="row">
							<div class="col-lg-6 col-sm-12 col-md-12">
								<div class="field_div1">發票日期:</div> 
								<div class="field_div3">
									<div class="input-group" id="invoice_order_date"  style="width:100%;max-width:250px;">
										<input type="text" class="form-control" name="invoice_order_date" placeholder="請輸入入庫日期" aria-describedby="invoice_order_date" value="$default_day">
										<button class="btn btn-outline-secondary input-group-append input-group-addon" type="button" data-target="#invoice_order_date" data-toggle="datetimepicker"><i class="bi bi-calendar"></i></button>
									</div>
									<script type="text/javascript">
										$(function () {
											$('#invoice_order_date').datetimepicker({
												locale: 'zh-tw'
												,format:"YYYY-MM-DD"
												,allowInputToggle: true
											});
										});
									</script>
								</div> 
							</div> 
							<div class="col-lg-6 col-sm-12 col-md-12">
								<div class="field_div1">應付性質:</div> 
								<div class="field_div2">
									<select id="payable_type" name="payable_type" placeholder="請選擇應付性質" style="width:100%;max-width:250px;">
										<option></option>
										<option value="採購">採購</option>
										<option value="勞務">勞務</option>
										<option value="勞務+採購">勞務+採購</option>
									</select>
								</div> 
							</div> 
						</div>
						<div class="row">
							<div class="col-lg-6 col-sm-12 col-md-12">
								<div class="field_div1">經辦人:</div> 
								<div class="field_div3">
									
									<div class="input-group text-nowrap" style="width:100%;max-width:450px;">
										<input readonly type="text" class="form-control w-25" id="handler_id" name="handler_id" aria-describedby="handler_id_addon" value="$employee_id"/>
										<input readonly type="text" class="form-control w-50" id="makeby" name="makeby"  value="$makeby"/>
										<button class="btn btn-outline-secondary w-25" type="button" id="handler_id_addon" onclick="openfancybox_edit('/index.php?ch=ch_employee&fm=$fm',800,'96%','');">選擇員工</button>
									</div> 
								</div> 
							</div>
							<div class="col-lg-6 col-sm-12 col-md-12">
								<div class="field_div1">施作地點:</div> 
								<div class="field_div2">
									<input type="text" class="inputtext" name="location" id="location" size="50" placeholder="請輸入施作地點" maxlength="50" style="width:100%;max-width:250px;"/>
								</div> 
							</div> 
						</div>
						<div class="row">
							<div class="col-lg-6 col-sm-12 col-md-12">
								<div class="field_div1">需求描述:</div> 
								<div class="field_div3">
									<textarea  name="requirement_description" id="requirement_description" rows="4" placeholder="請輸入需求描述" style="width:100%"></textarea>
								</div> 
							</div> 
						</div>
						<div class="row">
							<div class="col-lg-12 col-sm-12 col-md-12">
								<div class="field_div1">供應商:</div> 
								<div class="field_div2">
									<select id="supplier_id" name="supplier_id" placeholder="請選擇廠商" style="width:100%;max-width:250px;">
										$select_supplier
									</select>
								</div> 
							</div> 
						</div>
						<div class="row">
							<div class="col-lg-6 col-sm-12 col-md-12">
								<div class="field_div1">發票金額:</div> 
								<div class="field_div3">
									<input type="text" class="inputtext" name="invoice_amt" id="invoice_amt" size="50" placeholder="請輸入發票金額" maxlength="50" style="width:100%;max-width:250px;" value='$invoice_amt' />
								</div> 
							</div> 
						</div>
								
					</div>
				</div>


					<div class="form_btn_div mt-5 d-flex justify-content-center">
						<input type="hidden" name="fm" value="$fm" />
						<input type="hidden" name="site_db" value="$site_db" />
						<input type="hidden" name="templates" value="$templates" />
						<input type="hidden" name="employee_id" value="$employee_id" />
						<button class="btn btn-primary" type="button" onclick="CheckValue(this.form);" style="padding: 10px; margin: 0 10px;">
							<i class="bi bi-check-lg green"></i>&nbsp;確定新增
						</button>
						<button class="btn btn-danger" type="button" onclick="parent.myDraw();parent.$.fancybox.close();" style="padding: 10px; margin: 0 10px;">
							<i class="bi bi-power"></i>&nbsp;關閉
						</button>
					</div>

			</form>
		</div>
	</div>
</div>
<script>

function CheckValue(thisform) {
	xajax_processform(xajax.getFormValues('addForm'));
	thisform.submit();
}

var myDraw = function(){
	var oTable;
	oTable = parent.$('#db_table').dataTable();
	oTable.fnDraw(false);
}



</script>
EOT;

?>